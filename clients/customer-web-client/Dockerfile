FROM node:14.17.3-alpine AS builder
WORKDIR /app
COPY package*.json .
RUN yarn
COPY . .

ARG REACT_APP_STRIPE_API_KEY
ARG REACT_APP_STRIPE_SECRET_KEY
ARG REACT_APP_API_GATEWAY_URL
ARG REACT_APP_IDENTITY_PROVIDER_DOMAIN
ARG REACT_APP_IDENTITY_PROVIDER_CLIENT_ID
ARG REACT_APP_IDENTITY_PROVIDER_SCOPE
ARG REACT_APP_NOTIFICATION_HUB_URL
ARG REACT_APP_ORDERING_SERVICE
ARG REACT_APP_NOTIFICATION_SERVICE

ENV REACT_APP_STRIPE_API_KEY=$REACT_APP_STRIPE_API_KEY
ENV REACT_APP_STRIPE_SECRET_KEY=$REACT_APP_STRIPE_SECRET_KEY
ENV REACT_APP_API_GATEWAY_URL=$REACT_APP_API_GATEWAY_URL
ENV REACT_APP_IDENTITY_PROVIDER_DOMAIN=$REACT_APP_IDENTITY_PROVIDER_DOMAIN
ENV REACT_APP_IDENTITY_PROVIDER_CLIENT_ID=$REACT_APP_IDENTITY_PROVIDER_CLIENT_ID
ENV REACT_APP_IDENTITY_PROVIDER_SCOPE=$REACT_APP_IDENTITY_PROVIDER_SCOPE
ENV REACT_APP_NOTIFICATION_HUB_URL=$REACT_APP_NOTIFICATION_HUB_URL
ENV REACT_APP_ORDERING_SERVICE=$REACT_APP_ORDERING_SERVICE
ENV REACT_APP_NOTIFICATION_SERVICE=$REACT_APP_NOTIFICATION_SERVICE

RUN yarn build && yarn --production

FROM nginx:1.21.5-alpine
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/build /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]  